```{r include = F, echo = F}
source("../src/setup.R", echo = F)
```


<!------------------------------------------------------------------------------>
<!------------------------------------------------------------------------------>
***
# I. Data:
***

```{r data}

Thickness_target <- "Thickness"

# --------------------------------

thick_P12_responses <- c(
  "Thick_Total", 
  "Thick_EGL", 
  "Thick_MLPL",
  "Thick_IGL"
)

(thick_P12_data <- load_Thickness(stage = "P12"))

Thick_Total_name <- "Total thickness of the cerebellar cortex *(µm)*"
Thick_EGL_name <- "EGL thickness *(µm)*"
Thick_MLPL_name <- "ML+PL thickness *(µm)*"
Thick_IGL_name <- "IGL thickness *(µm)*"

contrasts(thick_P12_data$Condition) <- contr.treatment

thick_P12_data_agg <- thick_P12_data |>
  group_by(Mouse, Condition) |>
  summarize(across(all_of(thick_P12_responses), .fns = \(.x) mean(.x, na.rm = T))) |>
  ungroup() |>
  mutate(dCondition = as.numeric(Condition == "IH")) |>
  rowid_to_column("ID")

# --------------------------------

thick_P21_responses <- c(
  "Thick_Total", 
  "Thick_MLPL",
  "Thick_GL"
)

(thick_P21_data <- load_Thickness(stage = "P21"))

Thick_GL_name <- "GL thickness *(µm)*"

contrasts(thick_P21_data$Condition) <- contr.treatment

thick_P21_data_agg <- thick_P21_data |>
  group_by(Mouse, Condition) |>
  summarize(across(all_of(thick_P21_responses), .fns = \(.x) mean(.x, na.rm = T))) |>
  ungroup() |>
  mutate(dCondition = as.numeric(Condition == "IH")) |>
  rowid_to_column("ID")

# --------------------------------

thick_responses <- c("Thick_Total", "Thick_MLPL", "Prop_Thick_MLPL_in_Thick_Tot", "Thick_IGL", "Prop_Thick_IGL_in_Thick_Tot", "Thick_EGL")

(thick_data <- load_Thickness()
  |> mutate(
    Thick_IGL = coalesce(Thick_IGL, Thick_GL),
    Stage = factor(Stage),
    Prop_Thick_MLPL_in_Thick_Tot = Thick_MLPL / Thick_Total,
    Prop_Thick_IGL_in_Thick_Tot = Thick_IGL / Thick_Total,
  )
  |> select(-Thick_GL)
)

Prop_Thick_MLPL_in_Thick_Tot_name <- "Proportion of ML+PL thickness in the Total thickness  \n of the cerebellar cortex"
Prop_Thick_IGL_in_Thick_Tot_name <- "Proportion of GL thickness in the Total thickness  \n of the cerebellar cortex"

contrasts(thick_data$Condition) <- contr.sum
contrasts(thick_data$Stage) <- contr.sum
```


<!------------------------------------------------------------------------------>
## Correlations:
***

**P12:**

```{r fig.width = 6}
corr_matrix_plot(thick_P12_data, vars = c("Condition", thick_P12_responses))
```

```{r fig.width = 10}
GGally::ggpairs(
  thick_P12_data, columns = c("Condition", thick_P12_responses), 
  mapping = aes(color = Condition), lower = list(continuous = "smooth")
)
```

**P21:**

```{r fig.width = 6}
corr_matrix_plot(thick_P21_data, vars = c("Condition", thick_P21_responses))
```

```{r fig.width = 10}
GGally::ggpairs(
  thick_P21_data, columns = c("Condition", thick_P21_responses), 
  mapping = aes(color = Condition), lower = list(continuous = "smooth")
)
```


<!------------------------------------------------------------------------------>
## Composition:
***

**P12**

```{r}
compositional_plot(thick_P12_data, thick_P12_responses, prefix = "Thick")
```

**P21**

```{r}
compositional_plot(thick_P21_data, thick_P21_responses, prefix = "Thick") + scale_fill_viridis_d()
```

**Combined**

```{r}
compositional_plot(thick_data, thick_responses, prefix = "Thick") |> 
  save_png(filename = glue("[Combined] - Compositional Plot"), subfolder = Thickness_target, dpi = dpi_save_png, width = 5, height = 4)
```


<!------------------------------------------------------------------------------>
<!------------------------------------------------------------------------------>
***
# II. [P12] Analysis:
***

<!------------------------------------------------------------------------------>
## 1. Total Thickness:
***

<!------------------------------------------------------------------------------>
### a. Data Exploration:


```{r}
distribution_summary(thick_P12_data, dvs = "Thick_Total", between = "Condition")
```

```{r}
hist_plot(thick_P12_data, var = "Thick_Total")
```


<!------------------------------------------------------------------------------>
### b. Models:

#### Welch t-test:

On data averaged by Mouse.
Data is assumed heteroscedastic in relation to `Condition`.

```{r}
thick_P12_mod_Tot_agg <- afex::mixed(
  Thick_Total ~ Condition + (0 + dCondition | ID),
  data = thick_P12_data_agg,
  control = lmerControl(check.nobs.vs.nlev = "ignore", check.nobs.vs.nRE = "ignore"),
  check_contrasts = F,
  method = "S",
  type = 3,
  test_intercept = FALSE
)

parameters(thick_P12_mod_Tot_agg$full_model, effects = "fixed", ci_method = "satterthwaite", drop = "Intercept")
```


#### GLMM:

**Gaussian:**

```{r}
thick_P12_mod_Tot_gauss <- glmmTMB(
  Thick_Total ~ Condition + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = gaussian("log"),
  data = thick_P12_data,
  REML = T
)

parameters::parameters(thick_P12_mod_Tot_gauss)
cat("\n")
performance::performance(thick_P12_mod_Tot_gauss)
```

**Gamma:**

```{r}
thick_P12_mod_Tot_gamma <- glmmTMB(
  Thick_Total ~ Condition + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = Gamma("log"),
  data = thick_P12_data,
  REML = T
)

parameters::parameters(thick_P12_mod_Tot_gamma)
cat("\n")
performance::performance(thick_P12_mod_Tot_gamma)
```


<!------------------------------------------------------------------------------>
### c. Model Diagnostics:

**Model comparison:**

```{r}
performance::compare_performance(thick_P12_mod_Tot_gauss, thick_P12_mod_Tot_gamma)
```

Best model:

```{r}
thick_P12_mod_Tot <- thick_P12_mod_Tot_gamma
```


#### Residuals:

```{r fig.width = 8}
make_acf_plot(thick_P12_mod_Tot)

performance::check_model(thick_P12_mod_Tot, detrend = TRUE)
```


#### Predictions:

```{r}
nsim <- 300

thick_P12_mod_Tot_dharma <- DHARMa::simulateResiduals(thick_P12_mod_Tot, plot = F, n = nsim, seed = getOption("seed"))
thick_P12_mod_Tot_dharma_t <- thick_P12_mod_Tot_dharma$simulatedResponse |> t()
```

```{r fig.width = 10}
ppc_plots(thick_P12_mod_Tot, thick_P12_mod_Tot_dharma_t, term = "Condition")
```

```{r fig.width = 10}
ppc_stat_plots(thick_P12_mod_Tot, thick_P12_mod_Tot_dharma_t, term = "Condition")
```

**Potential outliers:**

```{r}
insight::get_data(thick_P12_mod_Tot) |> 
  filter(!is.na(Thick_Total)) |> 
  rownames_to_column("ID") |> 
  filter(ID %in% DHARMa::outliers(thick_P12_mod_Tot_dharma))
```

<!------------------------------------------------------------------------------>
### d. Effects Analysis:

#### Coefficients:

**All effects (Wald):**

```{r}
parameters::parameters(
  thick_P12_mod_Tot, exponentiate = should_exp(thick_P12_mod_Tot), 
  ci_method = "wald", p_adjust = "none", summary = T, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(thick_P12_mod_Tot, type = 3)
```

**Main effects (LRT):**

```{r}
LRT(thick_P12_mod_Tot, pred = "Condition")
```



#### Marginal Effects:

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_P12_mod_Tot), dvs = insight::find_response(thick_P12_mod_Tot), between = "Condition")

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_P12_mod_Tot, specs = "Condition", type = "response")
```

Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_P12_mod_Tot, specs = "Condition", type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_P12_mod_Tot, specs = "Condition", trans = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

Plot:

```{r fig.width = 2, fig.height = 3}
make_signif_boxplot(thick_P12_mod_Tot, xaxis = "Condition") |> 
  save_png(filename = glue("[P12] - [{get_model_tag(thick_P12_mod_Tot)}] Boxplots - by [Condition]"), subfolder = Thickness_target, dpi = dpi_save_png, width = 5, height = 8)
```


<!------------------------------------------------------------------------------>
## 2. EGL Thickness:
***

<!------------------------------------------------------------------------------>
### a. Data Exploration:


```{r}
distribution_summary(thick_P12_data, dvs = "Thick_EGL", between = "Condition")
```

```{r}
hist_plot(thick_P12_data, var = "Thick_EGL")
```


<!------------------------------------------------------------------------------>
### b. Models:

#### Welch t-test:

On data averaged by Mouse.
Data is assumed heteroscedastic in relation to `Condition`.

```{r}
thick_P12_mod_EGL_agg <- afex::mixed(
  Thick_EGL ~ Condition + (0 + dCondition | ID),
  data = thick_P12_data_agg,
  control = lmerControl(check.nobs.vs.nlev = "ignore", check.nobs.vs.nRE = "ignore"),
  check_contrasts = F,
  method = "S",
  type = 3,
  test_intercept = FALSE
)

parameters(thick_P12_mod_EGL_agg$full_model, effects = "fixed", ci_method = "satterthwaite", drop = "Intercept")
```


#### GLMM:

**Gaussian:**

```{r}
thick_P12_mod_EGL_gauss <- glmmTMB(
  Thick_EGL ~ Condition + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = gaussian("log"),
  data = thick_P12_data,
  REML = T
)

parameters::parameters(thick_P12_mod_EGL_gauss)
cat("\n")
performance::performance(thick_P12_mod_EGL_gauss)
```

**Gamma:**

```{r}
thick_P12_mod_EGL_gamma <- glmmTMB(
  Thick_EGL ~ Condition + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = Gamma("log"),
  data = thick_P12_data,
  REML = T
)

parameters::parameters(thick_P12_mod_EGL_gamma)
cat("\n")
performance::performance(thick_P12_mod_EGL_gamma)
```


<!------------------------------------------------------------------------------>
### c. Model Diagnostics:

**Model comparison:**

```{r}
performance::compare_performance(thick_P12_mod_EGL_gauss, thick_P12_mod_EGL_gamma)
```

Best model:

```{r}
thick_P12_mod_EGL <- thick_P12_mod_EGL_gamma
```


#### Residuals:

```{r fig.width = 8}
make_acf_plot(thick_P12_mod_EGL)

performance::check_model(thick_P12_mod_EGL, detrend = TRUE)
```


#### Predictions:

```{r}
nsim <- 300

thick_P12_mod_EGL_dharma <- DHARMa::simulateResiduals(thick_P12_mod_EGL, plot = F, n = nsim, seed = getOption("seed"))
thick_P12_mod_EGL_dharma_t <- thick_P12_mod_EGL_dharma$simulatedResponse |> t()
```

```{r fig.width = 10}
ppc_plots(thick_P12_mod_EGL, thick_P12_mod_EGL_dharma_t, term = "Condition")
```

```{r fig.width = 10}
ppc_stat_plots(thick_P12_mod_EGL, thick_P12_mod_EGL_dharma_t, term = "Condition")
```

**Potential outliers:**

```{r}
insight::get_data(thick_P12_mod_EGL) |> 
  filter(!is.na(Thick_EGL)) |> 
  rownames_to_column("ID") |> 
  filter(ID %in% DHARMa::outliers(thick_P12_mod_EGL_dharma))
```


<!------------------------------------------------------------------------------>
### d. Effects Analysis:

#### Coefficients:

**All effects (Wald):**

```{r}
parameters::parameters(
  thick_P12_mod_EGL, exponentiate = should_exp(thick_P12_mod_EGL), 
  ci_method = "wald", p_adjust = "none", summary = T, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(thick_P12_mod_EGL, type = 3)
```

**Main effects (LRT):**

```{r}
LRT(thick_P12_mod_EGL, pred = "Condition")
```

#### Marginal Effects:

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_P12_mod_EGL), dvs = insight::find_response(thick_P12_mod_EGL), between = "Condition")

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_P12_mod_EGL, specs = "Condition", type = "response")
```

Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_P12_mod_EGL, specs = "Condition", type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_P12_mod_EGL, specs = "Condition", trans = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

Plot:

```{r fig.width = 2, fig.height = 3}
make_signif_boxplot(thick_P12_mod_EGL, xaxis = "Condition") |> 
  save_png(filename = glue("[P12] - [{get_model_tag(thick_P12_mod_EGL)}] Boxplots - by [Condition]"), subfolder = Thickness_target, dpi = dpi_save_png, width = 5, height = 8)
```


<!------------------------------------------------------------------------------>
## 3. ML+PL Thickness:
***

<!------------------------------------------------------------------------------>
### a. Data Exploration:


```{r}
distribution_summary(thick_P12_data, dvs = "Thick_MLPL", between = "Condition")
```

```{r dig.width = 8}
hist_plot(thick_P12_data, var = "Thick_MLPL") + facet_grid(rows = vars(Condition), cols = vars(Slice))
```


<!------------------------------------------------------------------------------>
### b. Models:

#### Welch t-test:

On data averaged by Mouse.
Data is assumed heteroscedastic in relation to `Condition`.

```{r}
thick_P12_mod_MLPL_agg <- afex::mixed(
  Thick_MLPL ~ Condition + (0 + dCondition | ID),
  data = thick_P12_data_agg,
  control = lmerControl(check.nobs.vs.nlev = "ignore", check.nobs.vs.nRE = "ignore"),
  check_contrasts = F,
  method = "S",
  type = 3,
  test_intercept = FALSE
)

parameters(thick_P12_mod_MLPL_agg$full_model, effects = "fixed", ci_method = "satterthwaite", drop = "Intercept")
```


#### GLMM:

**Gaussian:**

```{r}
thick_P12_mod_MLPL_gauss <- glmmTMB(
  Thick_MLPL ~ Condition + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = gaussian("log"),
  data = thick_P12_data,
  REML = T
)

parameters::parameters(thick_P12_mod_MLPL_gauss)
cat("\n")
performance::performance(thick_P12_mod_MLPL_gauss)
```

**Gamma:**

```{r}
thick_P12_mod_MLPL_gamma <- glmmTMB(
  Thick_MLPL ~ Condition + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = Gamma("log"),
  data = thick_P12_data,
  REML = T
)

parameters::parameters(thick_P12_mod_MLPL_gamma)
cat("\n")
performance::performance(thick_P12_mod_MLPL_gamma)
```


<!------------------------------------------------------------------------------>
### c. Model Diagnostics:

**Model comparison:**

```{r}
performance::compare_performance(thick_P12_mod_MLPL_gauss, thick_P12_mod_MLPL_gamma)
```

Best model:

```{r}
thick_P12_mod_MLPL <- thick_P12_mod_MLPL_gamma
```


#### Residuals:

```{r fig.width = 8}
make_acf_plot(thick_P12_mod_MLPL)

performance::check_model(thick_P12_mod_MLPL, detrend = TRUE)
```


#### Predictions:

```{r}
nsim <- 300

thick_P12_mod_MLPL_dharma <- DHARMa::simulateResiduals(thick_P12_mod_MLPL, plot = F, n = nsim, seed = getOption("seed"))
thick_P12_mod_MLPL_dharma_t <- thick_P12_mod_MLPL_dharma$simulatedResponse |> t()
```

```{r fig.width = 10}
ppc_plots(thick_P12_mod_MLPL, thick_P12_mod_MLPL_dharma_t, term = "Condition")
```

```{r fig.width = 10}
ppc_stat_plots(thick_P12_mod_MLPL, thick_P12_mod_MLPL_dharma_t, term = "Condition")
```

**Potential outliers:**

```{r}
insight::get_data(thick_P12_mod_MLPL) |> 
  filter(!is.na(Thick_MLPL)) |> 
  rownames_to_column("ID") |> 
  filter(ID %in% DHARMa::outliers(thick_P12_mod_MLPL_dharma))
```


<!------------------------------------------------------------------------------>
### d. Effects Analysis:

#### Coefficients:

**All effects (Wald):**

```{r}
parameters::parameters(
  thick_P12_mod_MLPL, exponentiate = should_exp(thick_P12_mod_MLPL), 
  ci_method = "wald", p_adjust = "none", summary = T, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(thick_P12_mod_MLPL, type = 3)
```

**Main effects (LRT):**

```{r}
LRT(thick_P12_mod_MLPL, pred = "Condition")
```


#### Marginal Effects:

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_P12_mod_MLPL), dvs = insight::find_response(thick_P12_mod_MLPL), between = "Condition")

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_P12_mod_MLPL, specs = "Condition", type = "response")
```

Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_P12_mod_MLPL, specs = "Condition", type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_P12_mod_MLPL, specs = "Condition", trans = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

Plot:

```{r fig.width = 2, fig.height = 3}
make_signif_boxplot(thick_P12_mod_MLPL, xaxis = "Condition") |> 
  save_png(filename = glue("[P12] - [{get_model_tag(thick_P12_mod_MLPL)}] Boxplots - by [Condition]"), subfolder = Thickness_target, dpi = dpi_save_png, width = 5, height = 8)
```


<!------------------------------------------------------------------------------>
## 4. IGL Thickness:
***

<!------------------------------------------------------------------------------>
### a. Data Exploration:


```{r}
distribution_summary(thick_P12_data, dvs = "Thick_IGL", between = "Condition")
```

```{r}
hist_plot(thick_P12_data, var = "Thick_IGL")
```


<!------------------------------------------------------------------------------>
### b. Models:

#### Welch t-test:

On data averaged by Mouse.
Data is assumed heteroscedastic in relation to `Condition`.

```{r}
thick_P12_mod_IGL_agg <- afex::mixed(
  Thick_IGL ~ Condition + (0 + dCondition | ID),
  data = thick_P12_data_agg,
  control = lmerControl(check.nobs.vs.nlev = "ignore", check.nobs.vs.nRE = "ignore"),
  check_contrasts = F,
  method = "S",
  type = 3,
  test_intercept = FALSE
)

parameters(thick_P12_mod_IGL_agg$full_model, effects = "fixed", ci_method = "satterthwaite", drop = "Intercept")
```


#### GLMM:

**Gaussian:**

```{r}
thick_P12_mod_IGL_gauss <- glmmTMB(
  Thick_IGL ~ Condition + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = gaussian("log"),
  data = thick_P12_data,
  REML = T
)

parameters::parameters(thick_P12_mod_IGL_gauss)
cat("\n")
performance::performance(thick_P12_mod_IGL_gauss)
```

**Gamma:**

```{r}
thick_P12_mod_IGL_gamma <- glmmTMB(
  Thick_IGL ~ Condition + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = Gamma("log"),
  data = thick_P12_data,
  REML = T
)

parameters::parameters(thick_P12_mod_IGL_gamma)
cat("\n")
performance::performance(thick_P12_mod_IGL_gamma)
```


<!------------------------------------------------------------------------------>
### c. Model Diagnostics:

**Model comparison:**

```{r}
performance::compare_performance(thick_P12_mod_IGL_gauss, thick_P12_mod_IGL_gamma)
```

Best model:

```{r}
thick_P12_mod_IGL <- thick_P12_mod_IGL_gamma
```


#### Residuals:

```{r fig.width = 8}
make_acf_plot(thick_P12_mod_IGL)

performance::check_model(thick_P12_mod_IGL, detrend = TRUE)
```


#### Predictions:

```{r}
nsim <- 300

thick_P12_mod_IGL_dharma <- DHARMa::simulateResiduals(thick_P12_mod_IGL, plot = F, n = nsim, seed = getOption("seed"))
thick_P12_mod_IGL_dharma_t <- thick_P12_mod_IGL_dharma$simulatedResponse |> t()
```

```{r fig.width = 10}
ppc_plots(thick_P12_mod_IGL, thick_P12_mod_IGL_dharma_t, term = "Condition")
```

```{r fig.width = 10}
ppc_stat_plots(thick_P12_mod_IGL, thick_P12_mod_IGL_dharma_t, term = "Condition")
```

**Potential outliers:**

```{r}
insight::get_data(thick_P12_mod_IGL) |> 
  filter(!is.na(Thick_IGL)) |> 
  rownames_to_column("ID") |> 
  filter(ID %in% DHARMa::outliers(thick_P12_mod_IGL_dharma))
```


<!------------------------------------------------------------------------------>
### d. Effects Analysis:

#### Coefficients:

**All effects (Wald):**

```{r}
parameters::parameters(
  thick_P12_mod_IGL, exponentiate = should_exp(thick_P12_mod_IGL), 
  ci_method = "wald", p_adjust = "none", summary = T, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(thick_P12_mod_IGL, type = 3) |> parameters::parameters()
```

**Main effects (LRT):**

```{r}
LRT(thick_P12_mod_IGL, pred = "Condition")
```

#### Marginal Effects:

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_P12_mod_IGL), dvs = insight::find_response(thick_P12_mod_IGL), between = "Condition")

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_P12_mod_IGL, specs = "Condition", type = "response")
```

Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_P12_mod_IGL, specs = "Condition", type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_P12_mod_IGL, specs = "Condition", trans = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

Plot:

```{r fig.width = 2, fig.height = 3}
make_signif_boxplot(thick_P12_mod_IGL, xaxis = "Condition") |> 
  save_png(filename = glue("[P12] - [{get_model_tag(thick_P12_mod_IGL)}] Boxplots - by [Condition]"), subfolder = Thickness_target, dpi = dpi_save_png, width = 5, height = 8)
```



<!------------------------------------------------------------------------------>
<!------------------------------------------------------------------------------>
***
# III. [P21] Analysis:
***

<!------------------------------------------------------------------------------>
## 1. Total Thickness:
***

<!------------------------------------------------------------------------------>
### a. Data Exploration:


```{r}
distribution_summary(thick_P21_data, dvs = "Thick_Total", between = "Condition")
```

```{r}
hist_plot(thick_P21_data, var = "Thick_Total")
```


<!------------------------------------------------------------------------------>
### b. Models:

#### Welch t-test:

On data averaged by Mouse.
Data is assumed heteroscedastic in relation to `Condition`.

```{r}
thick_P21_mod_Tot_agg <- afex::mixed(
  Thick_Total ~ Condition + (0 + dCondition | ID),
  data = thick_P21_data_agg,
  control = lmerControl(check.nobs.vs.nlev = "ignore", check.nobs.vs.nRE = "ignore"),
  check_contrasts = F,
  method = "S",
  type = 3,
  test_intercept = FALSE
)

parameters(thick_P21_mod_Tot_agg$full_model, effects = "fixed", ci_method = "satterthwaite", drop = "Intercept")
```


#### GLMM:

**Gaussian:**

```{r}
thick_P21_mod_Tot_gauss <- glmmTMB(
  Thick_Total ~ Condition + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = gaussian("log"),
  data = thick_P21_data,
  REML = T
)

parameters::parameters(thick_P21_mod_Tot_gauss)
cat("\n")
performance::performance(thick_P21_mod_Tot_gauss)
```

**Gamma:**

```{r}
thick_P21_mod_Tot_gamma <- glmmTMB(
  Thick_Total ~ Condition + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = Gamma("log"),
  data = thick_P21_data,
  REML = T
)

parameters::parameters(thick_P21_mod_Tot_gamma)
cat("\n")
performance::performance(thick_P21_mod_Tot_gamma)
```


<!------------------------------------------------------------------------------>
### c. Model Diagnostics:

**Model comparison:**

```{r}
performance::compare_performance(thick_P21_mod_Tot_gauss, thick_P21_mod_Tot_gamma)
```

Best model:

```{r}
thick_P21_mod_Tot <- thick_P21_mod_Tot_gamma
```


#### Residuals:

```{r fig.width = 8}
make_acf_plot(thick_P21_mod_Tot)

performance::check_model(thick_P21_mod_Tot, detrend = TRUE)
```


#### Predictions:

```{r}
nsim <- 300

thick_P21_mod_Tot_dharma <- DHARMa::simulateResiduals(thick_P21_mod_Tot, plot = F, n = nsim, seed = getOption("seed"))
thick_P21_mod_Tot_dharma_t <- thick_P21_mod_Tot_dharma$simulatedResponse |> t()
```

```{r fig.width = 10}
ppc_plots(thick_P21_mod_Tot, thick_P21_mod_Tot_dharma_t, term = "Condition")
```

```{r fig.width = 10}
ppc_stat_plots(thick_P21_mod_Tot, thick_P21_mod_Tot_dharma_t, term = "Condition")
```

**Potential outliers:**

```{r}
insight::get_data(thick_P21_mod_Tot) |> 
  filter(!is.na(Thick_Total)) |> 
  rownames_to_column("ID") |> 
  filter(ID %in% DHARMa::outliers(thick_P21_mod_Tot_dharma))
```


<!------------------------------------------------------------------------------>
### d. Effects Analysis:

#### Coefficients:

**All effects (Wald):**

```{r}
parameters::parameters(
  thick_P21_mod_Tot, exponentiate = should_exp(thick_P21_mod_Tot), 
  ci_method = "wald", p_adjust = "none", summary = T, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(thick_P21_mod_Tot, type = 3)
```

**Main effects (LRT):**

```{r}
LRT(thick_P21_mod_Tot, pred = "Condition")
```


#### Marginal Effects:

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_P21_mod_Tot), dvs = insight::find_response(thick_P21_mod_Tot), between = "Condition")

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_P21_mod_Tot, specs = "Condition", type = "response")
```

Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_P21_mod_Tot, specs = "Condition", type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_P21_mod_Tot, specs = "Condition", trans = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

Plot:

```{r fig.width = 2, fig.height = 3}
make_signif_boxplot(thick_P21_mod_Tot, xaxis = "Condition") |> 
  save_png(filename = glue("[P21] - [{get_model_tag(thick_P21_mod_Tot)}] Boxplots - by [Condition]"), subfolder = Thickness_target, dpi = dpi_save_png, width = 5, height = 8)
```


<!------------------------------------------------------------------------------>
## 2. ML+PL Thickness:
***

<!------------------------------------------------------------------------------>
### a. Data Exploration:


```{r}
distribution_summary(thick_P21_data, dvs = "Thick_MLPL", between = "Condition")
```

```{r}
hist_plot(thick_P21_data, var = "Thick_MLPL")
```


<!------------------------------------------------------------------------------>
### b. Models:

#### Welch t-test:

On data averaged by Mouse.
Data is assumed heteroscedastic in relation to `Condition`.

```{r}
thick_P21_mod_MLPL_agg <- afex::mixed(
  Thick_MLPL ~ Condition + (0 + dCondition | ID),
  data = thick_P21_data_agg,
  control = lmerControl(check.nobs.vs.nlev = "ignore", check.nobs.vs.nRE = "ignore"),
  check_contrasts = F,
  method = "S",
  type = 3,
  test_intercept = FALSE
)

parameters(thick_P21_mod_MLPL_agg$full_model, effects = "fixed", ci_method = "satterthwaite", drop = "Intercept")
```


#### GLMM:

**Gaussian:**

```{r}
thick_P21_mod_MLPL_gauss <- glmmTMB(
  Thick_MLPL ~ Condition + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = gaussian("log"),
  data = thick_P21_data,
  REML = T
)

parameters::parameters(thick_P21_mod_MLPL_gauss)
cat("\n")
performance::performance(thick_P21_mod_MLPL_gauss)
```

**Gamma:**

```{r}
thick_P21_mod_MLPL_gamma <- glmmTMB(
  Thick_MLPL ~ Condition + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = Gamma("log"),
  data = thick_P21_data,
  REML = T
)

parameters::parameters(thick_P21_mod_MLPL_gamma)
cat("\n")
performance::performance(thick_P21_mod_MLPL_gamma)
```


<!------------------------------------------------------------------------------>
### c. Model Diagnostics:

**Model comparison:**

```{r}
performance::compare_performance(thick_P21_mod_MLPL_gauss, thick_P21_mod_MLPL_gamma)
```

Best model:

```{r}
thick_P21_mod_MLPL <- thick_P21_mod_MLPL_gamma
```


#### Residuals:

```{r fig.width = 8}
make_acf_plot(thick_P21_mod_MLPL)

performance::check_model(thick_P21_mod_MLPL, detrend = TRUE)
```


#### Predictions:

```{r}
nsim <- 300

thick_P21_mod_MLPL_dharma <- DHARMa::simulateResiduals(thick_P21_mod_MLPL, plot = F, n = nsim, seed = getOption("seed"))
thick_P21_mod_MLPL_dharma_t <- thick_P21_mod_MLPL_dharma$simulatedResponse |> t()
```

```{r fig.width = 10}
ppc_plots(thick_P21_mod_MLPL, thick_P21_mod_MLPL_dharma_t, term = "Condition")
```

```{r fig.width = 10}
ppc_stat_plots(thick_P21_mod_MLPL, thick_P21_mod_MLPL_dharma_t, term = "Condition")
```

**Potential outliers:**

```{r}
insight::get_data(thick_P21_mod_MLPL) |> 
  filter(!is.na(Thick_MLPL)) |> 
  rownames_to_column("ID") |> 
  filter(ID %in% DHARMa::outliers(thick_P21_mod_MLPL_dharma))
```


<!------------------------------------------------------------------------------>
### d. Effects Analysis:

#### Coefficients:

**All effects (Wald):**

```{r}
parameters::parameters(
  thick_P21_mod_MLPL, exponentiate = should_exp(thick_P21_mod_MLPL), 
  ci_method = "wald", p_adjust = "none", summary = T, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(thick_P21_mod_MLPL, type = 3)
```

**Main effects (LRT):**

```{r}
LRT(thick_P21_mod_MLPL, pred = "Condition")
```

#### Marginal Effects:

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_P21_mod_MLPL), dvs = insight::find_response(thick_P21_mod_MLPL), between = "Condition")

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_P21_mod_MLPL, specs = "Condition", type = "response")
```

Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_P21_mod_MLPL, specs = "Condition", type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_P21_mod_MLPL, specs = "Condition", trans = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

Plot:

```{r fig.width = 2, fig.height = 3}
make_signif_boxplot(thick_P21_mod_MLPL, xaxis = "Condition") |> 
  save_png(filename = glue("[P21] - [{get_model_tag(thick_P21_mod_MLPL)}] Boxplots - by [Condition]"), subfolder = Thickness_target, dpi = dpi_save_png, width = 5, height = 8)
```


<!------------------------------------------------------------------------------>
## 3. GL Thickness:
***

<!------------------------------------------------------------------------------>
### a. Data Exploration:


```{r}
distribution_summary(thick_P21_data, dvs = "Thick_GL", between = "Condition")
```

```{r}
hist_plot(thick_P21_data, var = "Thick_GL")
```


<!------------------------------------------------------------------------------>
### b. Models:

#### Welch t-test:

On data averaged by Mouse.
Data is assumed heteroscedastic in relation to `Condition`.

```{r}
thick_P21_mod_GL_agg <- afex::mixed(
  Thick_GL ~ Condition + (0 + dCondition | ID),
  data = thick_P21_data_agg,
  control = lmerControl(check.nobs.vs.nlev = "ignore", check.nobs.vs.nRE = "ignore"),
  check_contrasts = F,
  method = "S",
  type = 3,
  test_intercept = FALSE
)

parameters(thick_P21_mod_GL_agg$full_model, effects = "fixed", ci_method = "satterthwaite", drop = "Intercept")
```


#### GLMM:

**Gaussian:**

```{r}
thick_P21_mod_GL_gauss <- glmmTMB(
  Thick_GL ~ Condition + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = gaussian("log"),
  data = thick_P21_data,
  REML = T
)

parameters::parameters(thick_P21_mod_GL_gauss)
cat("\n")
performance::performance(thick_P21_mod_GL_gauss)
```

**Gamma:**

```{r}
thick_P21_mod_GL_gamma <- glmmTMB(
  Thick_GL ~ Condition + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = Gamma("log"),
  data = thick_P21_data,
  REML = T
)

parameters::parameters(thick_P21_mod_GL_gamma)
cat("\n")
performance::performance(thick_P21_mod_GL_gamma)
```


<!------------------------------------------------------------------------------>
### c. Model Diagnostics:

**Model comparison:**

```{r}
performance::compare_performance(thick_P21_mod_GL_gauss, thick_P21_mod_GL_gamma)
```

Best model:

```{r}
thick_P21_mod_GL <- thick_P21_mod_GL_gamma
```


#### Residuals:

```{r fig.width = 8}
make_acf_plot(thick_P21_mod_GL)

performance::check_model(thick_P21_mod_GL, detrend = TRUE)
```


#### Predictions:

```{r}
nsim <- 300

thick_P21_mod_GL_dharma <- DHARMa::simulateResiduals(thick_P21_mod_GL, plot = F, n = nsim, seed = getOption("seed"))
thick_P21_mod_GL_dharma_t <- thick_P21_mod_GL_dharma$simulatedResponse |> t()
```

```{r fig.width = 10}
ppc_plots(thick_P21_mod_GL, thick_P21_mod_GL_dharma_t, term = "Condition")
```

```{r fig.width = 10}
ppc_stat_plots(thick_P21_mod_GL, thick_P21_mod_GL_dharma_t, term = "Condition")
```

**Potential outliers:**

```{r}
insight::get_data(thick_P21_mod_GL) |> 
  filter(!is.na(Thick_GL)) |> 
  rownames_to_column("ID") |> 
  filter(ID %in% DHARMa::outliers(thick_P21_mod_GL_dharma))
```


<!------------------------------------------------------------------------------>
### d. Effects Analysis:

#### Coefficients:

**All effects (Wald):**

```{r}
parameters::parameters(
  thick_P21_mod_GL, exponentiate = should_exp(thick_P21_mod_GL), 
  ci_method = "wald", p_adjust = "none", summary = T, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(thick_P21_mod_GL, type = 3)
```

**Main effects (LRT):**

```{r}
LRT(thick_P21_mod_GL, pred = "Condition")
```


#### Marginal Effects:

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_P21_mod_GL), dvs = insight::find_response(thick_P21_mod_GL), between = "Condition")

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_P21_mod_GL, specs = "Condition", type = "response")
```

Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_P21_mod_GL, specs = "Condition", type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_P21_mod_GL, specs = "Condition", trans = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

Plot:

```{r fig.width = 2, fig.height = 3}
make_signif_boxplot(thick_P21_mod_GL, xaxis = "Condition") |> 
  save_png(filename = glue("[P21] - [{get_model_tag(thick_P21_mod_GL)}] Boxplots - by [Condition]"), subfolder = Thickness_target, dpi = dpi_save_png, width = 5, height = 8)
```


<!------------------------------------------------------------------------------>
<!------------------------------------------------------------------------------>
***
# IV. Combined:
***

<!------------------------------------------------------------------------------>
## 1. Total Thickness:
***

<!------------------------------------------------------------------------------>
### a. Data Exploration:


```{r}
distribution_summary(thick_data, dvs = "Thick_Total", between = "Condition")
```

```{r}
hist_plot(thick_data, var = "Thick_Total") + facet_grid(vars(Condition), vars(Stage))
```


<!------------------------------------------------------------------------------>
### b. Models:

**Gaussian:**

```{r}
thick_combined_mod_Tot_gauss <- glmmTMB(
  Thick_Total ~ Condition * Stage + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = gaussian("log"),
  data = thick_data,
  REML = T
)

parameters::parameters(thick_combined_mod_Tot_gauss)
cat("\n")
performance::performance(thick_combined_mod_Tot_gauss)
```

**Gamma:**

```{r}
thick_combined_mod_Tot_gamma <- glmmTMB(
  Thick_Total ~ Condition * Stage + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = Gamma("log"),
  data = thick_data,
  REML = T
)

parameters::parameters(thick_combined_mod_Tot_gamma)
cat("\n")
performance::performance(thick_combined_mod_Tot_gamma)
```


<!------------------------------------------------------------------------------>
### c. Model Diagnostics:

**Model comparison:**

```{r}
performance::compare_performance(thick_combined_mod_Tot_gauss, thick_combined_mod_Tot_gamma)
```

Best model:

```{r}
thick_combined_mod_Tot <- thick_combined_mod_Tot_gamma
```


#### Residuals:

```{r fig.width = 8}
make_acf_plot(thick_combined_mod_Tot)

performance::check_model(thick_combined_mod_Tot, detrend = TRUE)
```


#### Predictions:

```{r}
nsim <- 300

thick_combined_mod_Tot_dharma <- DHARMa::simulateResiduals(thick_combined_mod_Tot, plot = F, n = nsim, seed = getOption("seed"))
thick_combined_mod_Tot_dharma_t <- thick_combined_mod_Tot_dharma$simulatedResponse |> t()
```

```{r fig.width = 10}
ppc_plots(thick_combined_mod_Tot, thick_combined_mod_Tot_dharma_t, term = "Condition")
ppc_plots(thick_combined_mod_Tot, thick_combined_mod_Tot_dharma_t, term = "Stage")
```

```{r fig.width = 10}
ppc_stat_plots(thick_combined_mod_Tot, thick_combined_mod_Tot_dharma_t, term = "Condition")
ppc_stat_plots(thick_combined_mod_Tot, thick_combined_mod_Tot_dharma_t, term = "Stage")
```

**Potential outliers:**

```{r}
insight::get_data(thick_combined_mod_Tot) |> 
  filter(!is.na(Thick_Total)) |> 
  rownames_to_column("ID") |> 
  filter(ID %in% DHARMa::outliers(thick_combined_mod_Tot_dharma))
```

<!------------------------------------------------------------------------------>
### d. Effects Analysis:

#### Coefficients:

**All effects (Wald):**

```{r}
parameters::parameters(
  thick_combined_mod_Tot, exponentiate = should_exp(thick_combined_mod_Tot), 
  ci_method = "wald", p_adjust = "none", summary = T, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(thick_combined_mod_Tot, type = 3)
```

**Main effects (LRT):**

```{r}
LRT(thick_combined_mod_Tot, pred = "Condition")
```


#### Marginal Effects:

##### Condition:

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_combined_mod_Tot), dvs = insight::find_response(thick_combined_mod_Tot), between = "Condition")

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_combined_mod_Tot, specs = "Condition", type = "response")
```

Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_combined_mod_Tot, specs = "Condition", type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_combined_mod_Tot, specs = "Condition", trans = "response") |>
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

Plot:

```{r fig.width = 2, fig.height = 3, echo = F}
# make_signif_boxplot(thick_combined_mod_Tot, xaxis = "Condition") |> 
#  save_png(filename = glue("[Combined] - [{get_model_tag(thick_combined_mod_Tot)}] Boxplots - by [Condition]"), subfolder = Thickness_target, dpi = dpi_save_png, width = 5, height = 8)
```

##### Stage:

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_combined_mod_Tot), dvs = insight::find_response(thick_combined_mod_Tot), between = "Stage")

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_combined_mod_Tot, specs = "Stage", type = "response")
```

Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_combined_mod_Tot, specs = "Stage", type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_combined_mod_Tot, specs = "Stage", trans = "response") |>
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

Plot:

```{r fig.width = 5, fig.height = 8}
(make_signif_boxplot(thick_combined_mod_Tot, xaxis = "Stage") + scale_color_viridis_d()) |> 
  save_png(filename = glue("[Combined] - [{get_model_tag(thick_combined_mod_Tot)}] Boxplots - by [Stage]"), subfolder = Thickness_target, dpi = dpi_save_png, width = 5, height = 8)
```

##### Condition:Stage

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_combined_mod_Tot), dvs = insight::find_response(thick_combined_mod_Tot), between = c("Stage", "Condition"))

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_combined_mod_Tot, specs = ~ Condition | Stage, type = "response")
```

Marginal Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_combined_mod_Tot, specs = ~ Condition | Stage, type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.note("===[Interaction]===\n")

emmeans::emmeans(thick_combined_mod_Tot, specs = ~ Condition | Stage, type = "response") |>
  emmeans::contrast(interaction = c("pairwise"), by = NULL, adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_combined_mod_Tot, specs = ~ Condition | Stage, trans = "response") |>
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.note("===[Interaction]===\n")

emmeans::emmeans(thick_combined_mod_Tot, specs = ~ Condition | Stage, trans = "response") |>
  emmeans::contrast(interaction = c("pairwise"), by = NULL, adjust = "none", infer = TRUE)
```

Plots:

```{r fig.width = 6, fig.height = 5}
make_signif_boxplot(thick_combined_mod_Tot, xaxis = "Condition", facet = "Stage") |>
  save_png(
    filename = glue("[Combined] - [{get_model_tag(thick_combined_mod_Tot)}] Boxplots - by [Condition] within [Stage]"), 
    subfolder = Thickness_target, dpi = dpi_save_png, width = 10, height = 7
  )
```

```{r fig.width = 6, fig.height = 5}
make_signif_boxplot_inter(thick_combined_mod_Tot, xaxis = "Condition", facet = "Stage") |>
  save_png(
    filename = glue("[Combined] - [{get_model_tag(thick_combined_mod_Tot)}] Interaction Boxplots - by [Condition] within [Stage]"), 
    subfolder = Thickness_target, dpi = dpi_save_png, width = 10, height = 7
  )
```



<!------------------------------------------------------------------------------>
## 2. ML+PL Thickness:
***

<!------------------------------------------------------------------------------>
### a. Data Exploration:

```{r}
distribution_summary(thick_data, dvs = str_subset(thick_responses, "MLPL"), between = "Condition")
```

```{r fig.width = 6}
purrr::map(
  str_subset(thick_responses, "MLPL"),
  \(.x) hist_plot(thick_data, var = .x, facet = "Condition") + facet_grid(vars(Condition), vars(Stage))
)
```


<!------------------------------------------------------------------------------>
### b. Models:

#### Absolute:

**Gaussian:**

```{r}
thick_combined_mod_MLPL_gauss <- glmmTMB(
  Thick_MLPL ~ Condition * Stage + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = gaussian("log"),
  data = thick_data,
  REML = T
)

parameters::parameters(thick_combined_mod_MLPL_gauss)
cat("\n")
performance::performance(thick_combined_mod_MLPL_gauss)
```

**Gamma:**

```{r}
thick_combined_mod_MLPL_gamma <- glmmTMB(
  Thick_MLPL ~ Condition * Stage + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = Gamma("log"),
  data = thick_data,
  REML = T
)

parameters::parameters(thick_combined_mod_MLPL_gamma)
cat("\n")
performance::performance(thick_combined_mod_MLPL_gamma)
```


#### Relative (to Thick_Total):

**Beta:**

```{r}
thick_combined_mod_MLPL_beta <- glmmTMB(
  Prop_Thick_MLPL_in_Thick_Tot ~ Condition * Stage + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = beta_family("logit"),
  data = thick_data,
  REML = T,
  control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS"))
)

parameters::parameters(thick_combined_mod_MLPL_beta)
cat("\n")
performance::performance(thick_combined_mod_MLPL_beta)
```

<!------------------------------------------------------------------------------>
### c. Model Diagnostics:

**Model comparison:**

```{r}
performance::compare_performance(thick_combined_mod_MLPL_gauss, thick_combined_mod_MLPL_gamma)
```

Best model:

```{r}
thick_combined_mod_MLPL <- thick_combined_mod_MLPL_gamma
```


#### Residuals:

```{r fig.width = 8}
make_acf_plot(thick_combined_mod_MLPL)

performance::check_model(thick_combined_mod_MLPL, detrend = TRUE)
```


#### Predictions:

```{r}
nsim <- 300

thick_combined_mod_MLPL_dharma <- DHARMa::simulateResiduals(thick_combined_mod_MLPL, plot = F, n = nsim, seed = getOption("seed"))
thick_combined_mod_MLPL_dharma_t <- thick_combined_mod_MLPL_dharma$simulatedResponse |> t()
```

```{r fig.width = 10}
ppc_plots(thick_combined_mod_MLPL, thick_combined_mod_MLPL_dharma_t, term = "Condition")
ppc_plots(thick_combined_mod_MLPL, thick_combined_mod_MLPL_dharma_t, term = "Stage")
```

```{r fig.width = 10}
ppc_stat_plots(thick_combined_mod_MLPL, thick_combined_mod_MLPL_dharma_t, term = "Condition")
ppc_stat_plots(thick_combined_mod_MLPL, thick_combined_mod_MLPL_dharma_t, term = "Stage")
```

**Potential outliers:**

```{r}
insight::get_data(thick_combined_mod_MLPL) |> 
  filter(!is.na(insight::find_response(thick_combined_mod_MLPL))) |> 
  rownames_to_column("ID") |> 
  filter(ID %in% DHARMa::outliers(thick_combined_mod_MLPL_dharma))
```


<!------------------------------------------------------------------------------>
### d. Effects Analysis:

#### Coefficients:

**All effects (Wald):**

```{r}
parameters::parameters(
  thick_combined_mod_MLPL, exponentiate = should_exp(thick_combined_mod_MLPL), 
  ci_method = "wald", p_adjust = "none", summary = T, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(thick_combined_mod_MLPL, type = 3)
```

**Main effects (LRT):**

```{r}
LRT(thick_combined_mod_MLPL, pred = "Condition")
```


#### Marginal Effects:

##### Condition:

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_combined_mod_MLPL), dvs = insight::find_response(thick_combined_mod_MLPL), between = "Condition")

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_combined_mod_MLPL, specs = "Condition", type = "response")
```

Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_combined_mod_MLPL, specs = "Condition", type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_combined_mod_MLPL, specs = "Condition", trans = "response") |>
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

Plot:

```{r fig.width = 2, fig.height = 3, echo = F}
# make_signif_boxplot(thick_combined_mod_MLPL, xaxis = "Condition") |> 
#   save_png(filename = glue("[Combined] - [{get_model_tag(thick_combined_mod_MLPL)}] Boxplots - by [Condition]"), subfolder = Thickness_target, dpi = dpi_save_png, width = 5, height = 8)
```

##### Stage:

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_combined_mod_MLPL), dvs = insight::find_response(thick_combined_mod_MLPL), between = "Stage")

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_combined_mod_MLPL, specs = "Stage", type = "response")
```

Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_combined_mod_MLPL, specs = "Stage", type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_combined_mod_MLPL, specs = "Stage", trans = "response") |>
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

Plot:

```{r fig.width = 5, fig.height = 8}
(make_signif_boxplot(thick_combined_mod_MLPL, xaxis = "Stage") + scale_color_viridis_d()) |> 
  save_png(filename = glue("[Combined] - [{get_model_tag(thick_combined_mod_MLPL)}] Boxplots - by [Stage]"), subfolder = Thickness_target, dpi = dpi_save_png, width = 5, height = 8)
```

##### Condition:Stage

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_combined_mod_MLPL), dvs = insight::find_response(thick_combined_mod_MLPL), between = c("Condition", "Stage"))

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_combined_mod_MLPL, specs = ~ Stage | Condition, type = "response")
```

Marginal Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_combined_mod_MLPL, specs = ~ Condition | Stage, type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.note("===[Interaction]===\n")

emmeans::emmeans(thick_combined_mod_MLPL, specs = ~ Condition | Stage, type = "response") |>
  emmeans::contrast(interaction = c("pairwise"), by = NULL, adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_combined_mod_MLPL, specs = ~ Condition | Stage, trans = "response") |>
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.note("===[Interaction]===\n")

emmeans::emmeans(thick_combined_mod_MLPL, specs = ~ Condition | Stage, trans = "response") |>
  emmeans::contrast(interaction = c("pairwise"), by = NULL, adjust = "none", infer = TRUE)
```

Plots:

```{r fig.width = 6, fig.height = 5}
make_signif_boxplot(thick_combined_mod_MLPL, xaxis = "Condition", facet = "Stage") |>
  save_png(
    filename = glue("[Combined] - [{get_model_tag(thick_combined_mod_MLPL)}] Boxplots - by [Condition] within [Stage]"), 
    subfolder = Thickness_target, dpi = dpi_save_png, width = 10, height = 7
  )
```

```{r fig.width = 6, fig.height = 5}
make_signif_boxplot_inter(thick_combined_mod_MLPL, xaxis = "Condition", facet = "Stage") |>
  save_png(
    filename = glue("[Combined] - [{get_model_tag(thick_combined_mod_MLPL)}] Interaction Boxplots - by [Condition] within [Stage]"), 
    subfolder = Thickness_target, dpi = dpi_save_png, width = 10, height = 7
  )
```



<!------------------------------------------------------------------------------>
## 3. (I)GL Thickness:
***

<!------------------------------------------------------------------------------>
### a. Data Exploration:

```{r}
distribution_summary(thick_data, dvs = str_subset(thick_responses, "IGL"), between = "Condition")
```

```{r fig.width = 6}
purrr::map(
  str_subset(thick_responses, "GL"),
  \(.x) hist_plot(thick_data, var = .x, facet = "Condition") + facet_grid(vars(Condition), vars(Stage))
)
```


<!------------------------------------------------------------------------------>
### b. Models:

#### Absolute:

**Gaussian:**

```{r}
thick_combined_mod_IGL_gauss <- glmmTMB(
  Thick_IGL ~ Condition * Stage + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = gaussian("log"),
  data = thick_data,
  REML = T,
)

parameters::parameters(thick_combined_mod_IGL_gauss)
cat("\n")
performance::performance(thick_combined_mod_IGL_gauss)
```

**Gamma:**

```{r}
thick_combined_mod_IGL_gamma <- glmmTMB(
  Thick_IGL ~ Condition * Stage + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = Gamma("log"),
  data = thick_data,
  REML = T,
)

parameters::parameters(thick_combined_mod_IGL_gamma)
cat("\n")
performance::performance(thick_combined_mod_IGL_gamma)
```

#### Relative (to Thick_Total):

**Beta:**

```{r}
thick_combined_mod_IGL_beta <- glmmTMB(
  Prop_Thick_IGL_in_Thick_Tot ~ Condition * Stage + (1 | Mouse) + (1 | Slice), # Equivalent to (1 | Mouse/Slice) since we encoded slices with mouse-specific codes
  family = beta_family("logit"),
  data = thick_data,
  REML = T,
)

parameters::parameters(thick_combined_mod_IGL_beta)
cat("\n")
performance::performance(thick_combined_mod_IGL_beta)
```


<!------------------------------------------------------------------------------>
### c. Model Diagnostics:

**Model comparison:**

```{r}
performance::compare_performance(thick_combined_mod_IGL_gauss, thick_combined_mod_IGL_gamma)
```

Best model:

```{r}
thick_combined_mod_IGL <- thick_combined_mod_IGL_gamma
```


#### Residuals:

```{r fig.width = 8}
make_acf_plot(thick_combined_mod_IGL)

performance::check_model(thick_combined_mod_IGL, detrend = TRUE)
```


#### Predictions:

```{r}
nsim <- 300

thick_combined_mod_IGL_dharma <- DHARMa::simulateResiduals(thick_combined_mod_IGL, plot = F, n = nsim, seed = getOption("seed"))
thick_combined_mod_IGL_dharma_t <- thick_combined_mod_IGL_dharma$simulatedResponse |> t()
```

```{r fig.width = 10}
ppc_plots(thick_combined_mod_IGL, thick_combined_mod_IGL_dharma_t, term = "Condition")
ppc_plots(thick_combined_mod_IGL, thick_combined_mod_IGL_dharma_t, term = "Stage")
```

```{r fig.width = 10}
ppc_stat_plots(thick_combined_mod_IGL, thick_combined_mod_IGL_dharma_t, term = "Condition")
ppc_stat_plots(thick_combined_mod_IGL, thick_combined_mod_IGL_dharma_t, term = "Stage")
```

**Potential outliers:**

```{r}
insight::get_data(thick_combined_mod_IGL) |> 
  filter(!is.na(insight::find_response(thick_combined_mod_IGL))) |> 
  rownames_to_column("ID") |> 
  filter(ID %in% DHARMa::outliers(thick_combined_mod_IGL_dharma))
```


<!------------------------------------------------------------------------------>
### d. Effects Analysis:

#### Coefficients:

**All effects (Wald):**

```{r}
parameters::parameters(
  thick_combined_mod_IGL, exponentiate = should_exp(thick_combined_mod_IGL), 
  ci_method = "wald", p_adjust = "none", summary = T, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(thick_combined_mod_IGL, type = 3)
```

**Main effects (LRT):**

```{r}
LRT(thick_combined_mod_IGL, pred = "Condition")
```


#### Marginal Effects:

##### Condition:

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_combined_mod_IGL), dvs = insight::find_response(thick_combined_mod_IGL), between = "Condition")

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_combined_mod_IGL, specs = "Condition", type = "response")
```

Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_combined_mod_IGL, specs = "Condition", type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_combined_mod_IGL, specs = "Condition", trans = "response") |>
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

Plot:

```{r fig.width = 2, fig.height = 3, echo = F}
# make_signif_boxplot(thick_combined_mod_IGL, xaxis = "Condition") |> 
#   save_png(filename = glue("[Combined] - [{get_model_tag(thick_combined_mod_IGL)}] Boxplots - by [Condition]"), subfolder = Thickness_target, dpi = dpi_save_png, width = 5, height = 8)
```

##### Stage:

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_combined_mod_IGL), dvs = insight::find_response(thick_combined_mod_IGL), between = "Stage")

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_combined_mod_IGL, specs = "Stage", type = "response")
```

Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_combined_mod_IGL, specs = "Stage", type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_combined_mod_IGL, specs = "Stage", trans = "response") |>
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)
```

Plot:

```{r fig.width = 5, fig.height = 8}
(make_signif_boxplot(thick_combined_mod_IGL, xaxis = "Stage") + scale_color_viridis_d()) |> 
  save_png(filename = glue("[Combined] - [{get_model_tag(thick_combined_mod_IGL)}] Boxplots - by [Stage]"), subfolder = Thickness_target, dpi = dpi_save_png, width = 5, height = 8)
```

##### Condition:Stage

Marginal Means:

```{r}
log.main("===[Observed]===\n")

distribution_summary(insight::get_data(thick_combined_mod_IGL), dvs = insight::find_response(thick_combined_mod_IGL), between = c("Condition", "Stage"))

log.main("===[Emmeans]===\n")

emmeans::emmeans(thick_combined_mod_IGL, specs = ~ Stage | Condition, type = "response")
```

Marginal Contrasts:

```{r}
log.main("===[Link scale]===\n")

emmeans::emmeans(thick_combined_mod_IGL, specs = ~ Condition | Stage, type = "response") |> 
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.note("===[Interaction]===\n")

emmeans::emmeans(thick_combined_mod_IGL, specs = ~ Condition | Stage, type = "response") |>
  emmeans::contrast(interaction = c("pairwise"), by = NULL, adjust = "none", infer = TRUE)

log.main("===[Response scale]===\n")

emmeans::emmeans(thick_combined_mod_IGL, specs = ~ Condition | Stage, trans = "response") |>
  emmeans::contrast(method = "pairwise", adjust = "none", infer = TRUE)

log.note("===[Interaction]===\n")

emmeans::emmeans(thick_combined_mod_IGL, specs = ~ Condition | Stage, trans = "response") |>
  emmeans::contrast(interaction = c("pairwise"), by = NULL, adjust = "none", infer = TRUE)
```

Plots:

```{r fig.width = 6, fig.height = 5}
make_signif_boxplot(thick_combined_mod_IGL, xaxis = "Condition", facet = "Stage") |>
  save_png(
    filename = glue("[Combined] - [{get_model_tag(thick_combined_mod_IGL)}] Boxplots - by [Condition] within [Stage]"), 
    subfolder = Thickness_target, dpi = dpi_save_png, width = 10, height = 7
  )
```

```{r fig.width = 6, fig.height = 5}
make_signif_boxplot_inter(thick_combined_mod_IGL, xaxis = "Condition", facet = "Stage") |>
  save_png(
    filename = glue("[Combined] - [{get_model_tag(thick_combined_mod_IGL)}] Interaction Boxplots - by [Condition] within [Stage]"),
    subfolder = Thickness_target, dpi = dpi_save_png, width = 10, height = 7
  )
```
