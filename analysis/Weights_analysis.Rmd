```{r include = F, echo = F}
source("../src/init.R", echo = F)
```

<!------------------------------------------------------------------------------>
<!------------------------------------------------------------------------------>
***
# I. Data:
***

```{r data}

weight_target <- "Weight"

# --------------------------------

(weight_data_pups_teens <- load_Weights(config$data$weight_path, "Pups_Teens") |> mutate(Day = datawizard::center(Day)))

contrasts(weight_data_pups_teens$Condition) <- contr.sum
contrasts(weight_data_pups_teens$Stage) <- contr.sum

# --------------------------------

(weight_data_adults <- load_Weights(config$data$weight_path, "Adults")
  |> mutate(Day = datawizard::center(Day))
)

contrasts(weight_data_adults$Condition) <- contr.sum
contrasts(weight_data_adults$Stage) <- contr.sum
```

```{r}
weight_data_pups_teens %>% filter_all(any_vars(is.na(.)))

weight_data_adults %>% filter_all(any_vars(is.na(.)))
```


<!------------------------------------------------------------------------------>
<!------------------------------------------------------------------------------>
***
# II. Weight (pups & teens):
***

<!------------------------------------------------------------------------------>
## 1. Data Exploration:
***

<!------------------------------------------------------------------------------>
### Correlations:

```{r fig.width = 6}
corr_matrix_plot(weight_data_pups_teens, vars = c("Condition", "Mouse", "Weight"))
```

<!------------------------------------------------------------------------------>
### Distributions:

```{r}
distribution_summary(weight_data_pups_teens, dvs = "Weight", between = "Condition")
```

```{r}
hist_plot(weight_data_pups_teens, var = "Weight", facet = "Condition")
```

<!------------------------------------------------------------------------------>
### Temporal Evolution:

**Stage:Condition:**

```{r fig.width = 14, fig.height = 3}
temporal_dist_plot(weight_data_pups_teens, "Weight")
```

**Global trajectory:**

```{r fig.width = 8}
temporal_plot(weight_data_pups_teens, resp = "Weight", pred = "Condition", time = "Stage")
```

**Individual trajectories:**

```{r fig.width = 6}
weight_data_pups_teens |> 
  ggplot(aes(x = Day, y = Weight, group = Mouse, color = Mouse)) +
  geom_line() +
  ylim(0, NA) +
  facet_wrap(~ Condition)
```


<!------------------------------------------------------------------------------>
## 2. Models:
***

**GLM (Gamma) + AR1**

```{r}
mod_weight_pups_teens <- glmmTMB(
  formula = Weight ~ Condition * Stage + ar1(Stage + 0 | Mouse),
  family = Gamma("log"),
  data = weight_data_pups_teens,
  REML = T
)

parameters::parameters(mod_weight_pups_teens)
cat("\n")
performance::performance(mod_weight_pups_teens)
```


<!------------------------------------------------------------------------------>
## 3. Model Diagnostics:

### Residuals:

```{r fig.width = 10}
make_acf_plot(mod_weight_pups_teens)

performance::check_model(mod_weight_pups_teens, detrend = TRUE)
```


### Predictions:

```{r}
nsim <- 300

mod_weight_pups_teens_dharma <- DHARMa::simulateResiduals(mod_weight_pups_teens, plot = F, n = nsim, seed = getOption("seed"))
mod_weight_pups_teens_dharma_t <- mod_weight_pups_teens_dharma$simulatedResponse |> t()
```

```{r fig.width = 8}
ppc_plots(mod_weight_pups_teens, mod_weight_pups_teens_dharma_t, term = "Condition")
ppc_plots(mod_weight_pups_teens, mod_weight_pups_teens_dharma_t, term = "Stage")
```

```{r fig.width = 8}
ppc_stat_plots(mod_weight_pups_teens, mod_weight_pups_teens_dharma_t, term = "Condition")
ppc_stat_plots(mod_weight_pups_teens, mod_weight_pups_teens_dharma_t, term = "Stage")
```

**Potential outliers:**

```{r}
insight::get_data(mod_weight_pups_teens) |> 
  rownames_to_column("ID") |> 
  filter(ID %in% DHARMa::outliers(mod_weight_pups_teens_dharma))
```


<!------------------------------------------------------------------------------>
## 4. Effects Analysis:

### Coefficients:

**All effects (Wald):**

```{r}
parameters::parameters(
  mod_weight_pups_teens, exponentiate = should_exp(mod_weight_pups_teens), 
  ci_method = "wald", p_adjust = "none", summary = T, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(mod_weight_pups_teens, type = 3)
```

**Main effects (LRT):**

```{r}
# LRT(mod_weight_pups_teens, pred = "Condition") # Model cannot be re-fitted with REML = FALSE
```


### Marginal Effects:

Marginal means:

```{r}
(mod_weight_pups_teens_emm <- inner_join(
  emmeans::emmeans(
    object = mod_weight_pups_teens, 
    specs = ~ Stage | Condition, 
    type = "response",
    lmer.df = "satterthwaite"
  ) |> as.data.frame() |> 
    select(Stage, Condition, Modeled = matches("response|emmean"), matches("CL$")),

  distribution_summary(
    insight::get_data(mod_weight_pups_teens), 
    dvs = insight::find_response(mod_weight_pups_teens), 
    between = c("Condition", "Stage")
  ) |> select(Stage, Condition, Observed = Mean)
) |> select(Stage, Condition, Observed, Modeled, everything()))
```

Contrasts:

```{r}
(mod_weight_pups_teens_contrasts <- emmeans::emmeans(
  object = mod_weight_pups_teens, 
  specs = ~ Condition | Stage, 
  type = "response",
  adjust = "none"
) 
|> emmeans::contrast(method = "pairwise", type = "response", infer = TRUE) 
|> data.frame()
|> select(contrast, Stage, matches("estimate|risk|odds|^ratio|^difference"), matches("CL$"), p.value)
)
```

Plots:

```{r fig.width = 2, fig.height = 3}
make_signif_boxplot(mod_weight_pups_teens, xaxis = "Condition") |> 
  save_png(filename = glue("[Pups & Teens] - [GLM (Gamma) + AR1] Boxplots - by [Condition]"), subfolder = weight_target, dpi = 600, width = 5, height = 8)
```

```{r fig.width = 6}
modeled_temporal_plot(mod_weight_pups_teens, mod_weight_pups_teens_emm, mod_weight_pups_teens_contrasts, xlims = paste0("P", 2:21), zero_hline = FALSE) |> 
  save_png(filename = glue("[Pups & Teens] - [GLM (Gamma) + AR1] Temporal evolution - by [Condition]"), subfolder = weight_target, dpi = 600, width = 12, height = 8)
```


**Individual trajectories:**

```{r fig.width = 5}
predict(mod_weight_pups_teens, type = "response") |> 
  data.frame() |> 
  set_names("Predicted") |> 
  bind_cols(insight::get_data(mod_weight_pups_teens)) |>  
  ggplot(aes(x = Stage, y = Predicted, group = Mouse, color = Condition)) +
    geom_line(aes(color = Condition)) +
    scale_x_discrete(limits = paste0("P", 2:21)) +
    labs(title = "Mouse-level trajectories") +
    theme(legend.position = "bottom")
```


<!------------------------------------------------------------------------------>
<!------------------------------------------------------------------------------>
***
# III. Weight (adults):
***

<!------------------------------------------------------------------------------>
## 1. Data Exploration:
***

<!------------------------------------------------------------------------------>
### Correlations:

```{r fig.width = 6}
corr_matrix_plot(weight_data_adults, vars = c("Condition", "Mouse", "Weight"))
```

<!------------------------------------------------------------------------------>
### Distributions:

```{r}
distribution_summary(weight_data_adults, dvs = "Weight", between = "Condition")
```

```{r}
hist_plot(weight_data_adults, var = "Weight", facet = "Condition")
```

<!------------------------------------------------------------------------------>
### Temporal Evolution:

**Stage:Condition:**

```{r fig.width = 6, fig.height = 3}
temporal_dist_plot(weight_data_adults, "Weight")
```

**Global trajectory:**

```{r fig.width = 6}
temporal_plot(weight_data_adults, resp = "Weight", pred = "Condition", time = "Stage")
```

**Individual trajectories:**

```{r fig.width = 6}
weight_data_adults |> 
  ggplot(aes(x = Day, y = Weight, group = Mouse, color = Mouse)) +
  geom_line() +
  ylim(0, NA) +
  facet_wrap(~ Condition)
```

<!------------------------------------------------------------------------------>
## 2. Models:
***

**GLM (Gamma) + AR1:**

```{r}
weight_mod_adults <- glmmTMB(
  Weight ~ Condition * Stage + ar1(Stage + 0 | Mouse),
  family = Gamma("log"),
  data = weight_data_adults,
  REML = T
)

parameters::parameters(weight_mod_adults)
cat("\n")
performance::performance(weight_mod_adults)
```


<!------------------------------------------------------------------------------>
## 3. Model Diagnostics:
***

### Residuals:

```{r fig.width = 8}
make_acf_plot(weight_mod_adults)

performance::check_model(weight_mod_adults, detrend = TRUE)
```


### Predictions:

```{r}
nsim <- 300

weight_mod_adults_dharma <- DHARMa::simulateResiduals(weight_mod_adults, plot = F, n = nsim, seed = getOption("seed"))
weight_mod_adults_dharma_t <- weight_mod_adults_dharma$simulatedResponse |> t()
```

```{r fig.width = 8}
ppc_plots(weight_mod_adults, weight_mod_adults_dharma_t, term = "Condition")
ppc_plots(weight_mod_adults, weight_mod_adults_dharma_t, term = "Stage")
```

```{r fig.width = 8}
ppc_stat_plots(weight_mod_adults, weight_mod_adults_dharma_t, term = "Condition")
ppc_stat_plots(weight_mod_adults, weight_mod_adults_dharma_t, term = "Stage")
```

**Potential outliers:**

```{r}
insight::get_data(weight_mod_adults) |> 
  rownames_to_column("ID") |> 
  filter(ID %in% DHARMa::outliers(weight_mod_adults_dharma))
```


<!------------------------------------------------------------------------------>
## 4. Effects Analysis:
***

### Coefficients:

**All effects (Wald):**

```{r}
parameters::parameters(
  weight_mod_adults, exponentiate = should_exp(weight_mod_adults), 
  ci_method = "Wald", p_adjust = "none", summary = T, digits = 3
)
```

**Main effects (Wald):**

```{r}
car::Anova(weight_mod_adults, type = 3)
```

**Main effects (LRT):**

```{r}
LRT(weight_mod_adults, pred = "Condition")
```


### Marginal Effects:

Marginal means:

```{r}
(weight_mod_adults_emm <- inner_join(
  emmeans::emmeans(
    object = weight_mod_adults, 
    specs = ~ Stage | Condition, 
    type = "response",
    lmer.df = "satterthwaite"
  ) |> as.data.frame() |> 
    select(Stage, Condition, Modeled = matches("response|emmean"), matches("CL$")),

  distribution_summary(
    insight::get_data(weight_mod_adults), 
    dvs = insight::find_response(weight_mod_adults), 
    between = c("Condition", "Stage")
  ) |> select(Stage, Condition, Observed = Mean)
) |> select(Stage, Condition, Observed, Modeled, everything()))
```

Contrasts:

```{r}
(weight_mod_adults_contrasts <- emmeans::emmeans(
  object = weight_mod_adults, 
  specs = ~ Condition | Stage, 
  type = "response",
  adjust = "none"
) 
|> emmeans::contrast(method = "pairwise", type = "response", infer = TRUE) 
|> data.frame()
|> select(contrast, Stage, matches("estimate|risk|odds|^ratio|^difference"), matches("CL$"), p.value)
)
```

Plots:

```{r fig.width = 2, fig.height = 3}
make_signif_boxplot(weight_mod_adults, xaxis = "Condition") |> 
  save_png(filename = glue("[Adults] - [GLM (Gamma) + AR1] Boxplots - by [Condition]"), subfolder = weight_target, dpi = 600, width = 5, height = 8)
```

```{r fig.width = 6}
modeled_temporal_plot(weight_mod_adults, weight_mod_adults_emm, weight_mod_adults_contrasts, zero_hline = FALSE) |> 
  save_png(filename = glue("[Adults] - [GLM (Gamma) + AR1] Temporal evolution - by [Condition]"), subfolder = weight_target, dpi = 600, width = 12, height = 8)
```

